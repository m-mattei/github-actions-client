name: Release on merged PR to main

on:
  workflow_run:
    workflows:
      - "Java CI"
    types:
      - completed

permissions:
  contents: write
  packages: write

jobs:
  release:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Identify merged PR and artifact from triggering Java CI run
        id: identify_pr
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const run = context.payload.workflow_run;
            const runId = run.id;
            const headSha = run.head_sha;
            core.info(`Triggered by Java CI run id=${runId} head_sha=${headSha}`);

            // Find PRs associated with this commit
            const prsResp = await github.rest.repos.listPullRequestsAssociatedWithCommit({ owner, repo, commit_sha: headSha });
            const prs = prsResp.data || [];
            core.info(`Found ${prs.length} PR(s) associated with commit ${headSha}`);

            // Find a merged PR that targeted main
            let mergedPr = null;
            for (const p of prs) {
              const prDetails = await github.rest.pulls.get({ owner, repo, pull_number: p.number });
              if (prDetails.data && prDetails.data.base && prDetails.data.base.ref === 'main' && prDetails.data.merged === true) {
                mergedPr = prDetails.data;
                break;
              }
            }

            if (!mergedPr) {
              core.info('No merged PR into main associated with this run; nothing to do.');
              return { skip: true };
            }

            core.info(`Found merged PR #${mergedPr.number} (head ref=${mergedPr.head.ref}, head sha=${mergedPr.head.sha})`);

            // Get artifacts for this run
            const arts = await github.rest.actions.listWorkflowRunArtifacts({ owner, repo, run_id: runId });
            if (!arts || !arts.data || !Array.isArray(arts.data.artifacts) || arts.data.artifacts.length === 0) {
              throw new Error(`No artifacts found for Java CI run ${runId}`);
            }
            const artifact = arts.data.artifacts.find(a => a.name === 'build-artifacts') || arts.data.artifacts[0];

            return {
              archive_url: artifact.archive_download_url,
              run_id: runId,
              pr_number: mergedPr.number,
              pr_user_login: mergedPr.user ? mergedPr.user.login : '',
              pr_head_ref: mergedPr.head.ref,
              pr_head_sha: mergedPr.head.sha
            };

      - name: Compute branch tag and commit
        id: set_tag
        run: |
          set -euo pipefail
          IDENT="${{ steps.identify_pr.outputs.result }}"
          if [ -z "$IDENT" ] || [ "$IDENT" = "null" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          pr_head_ref=$(echo "$IDENT" | jq -r '.pr_head_ref')
          pr_head_sha=$(echo "$IDENT" | jq -r '.pr_head_sha')
          sanitized=${pr_head_ref//\//-}
          tag="branch-${sanitized}"
          echo "release_tag=$tag" >> "$GITHUB_OUTPUT"
          echo "release_commit=$pr_head_sha" >> "$GITHUB_OUTPUT"

      - name: Extract metadata (branch type/story id and project version)
        id: metadata
        run: |
          set -euo pipefail
          IDENT="${{ steps.identify_pr.outputs.result }}"
          pr_head_ref=$(echo "$IDENT" | jq -r '.pr_head_ref')
          # try patterns like "fix - 123 - description" or "fix-123-description" or "fix/123-desc"
          branch_name=$(echo "$pr_head_ref" | sed 's/^\s*//;s/\s*$//')
          # normalize separators to hyphen then split
          norm=$(echo "$branch_name" | sed 's#[/_]#-#g')
          IFS='-' read -r part1 part2 _ <<< "$norm"
          branch_type=$(echo "$part1" | tr '[:upper:]' '[:lower:]' | sed 's/ //g')
          story_id=$(echo "$part2" | sed 's/[^A-Za-z0-9]//g')
          # get project version
          project_version=$(mvn -q -Dexec.executable=echo -Dexec.args='${project.version}' --non-recursive org.codehaus.mojo:exec-maven-plugin:3.1.0:exec || true)
          if [ -z "$project_version" ]; then
            project_version=$(grep -m1 -oP '(?<=<version>)[^<]+' pom.xml || echo "unknown")
          fi
          echo "branch_type=$branch_type" >> "$GITHUB_OUTPUT"
          echo "story_id=$story_id" >> "$GITHUB_OUTPUT"
          echo "project_version=$project_version" >> "$GITHUB_OUTPUT"

      - name: Create/force-update branch tag
        if: ${{ steps.set_tag.outputs.release_tag != '' }}
        run: |
          set -euo pipefail
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          tag="${{ steps.set_tag.outputs.release_tag }}"
          commit="${{ steps.set_tag.outputs.release_commit }}"
          git tag -f "$tag" "$commit"
          git push -f origin "refs/tags/$tag"
        env:
          GITHUB_ACTOR: ${{ github.actor }}

      - name: Download artifact archive and extract
        run: |
          set -euo pipefail
          IDENT="${{ steps.identify_pr.outputs.result }}"
          archive_url=$(echo "$IDENT" | jq -r '.archive_url')
          if [ -z "$archive_url" ] || [ "$archive_url" = "null" ]; then
            echo "No archive URL found" >&2
            exit 1
          fi
          mkdir -p downloaded-artifacts
          curl -sL -H "Authorization: Bearer $GITHUB_TOKEN" -o /tmp/artifact.zip "$archive_url"
          unzip -o /tmp/artifact.zip -d downloaded-artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish JAR(s) to GitHub Packages (Maven)
        if: ${{ always() }}
        run: |
          set -euo pipefail
          repo_url="https://maven.pkg.github.com/${{ github.repository }}"
          for jar in downloaded-artifacts/target/*.jar; do
            echo "Publishing $jar to $repo_url"
            mvn -B org.apache.maven.plugins:maven-deploy-plugin:3.0.0:deploy-file \
              -Dfile="$jar" \
              -DpomFile=pom.xml \
              -DrepositoryId=github \
              -Durl="$repo_url"
          done

      - name: Create or update release, upload assets and add labels
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const tag = process.env.RELEASE_TAG;
            const identify = JSON.parse(process.env.IDENTIFY_JSON || '{}');
            const pr_number = identify.pr_number;
            const pr_user = identify.pr_user_login || '';
            const pr_head_ref = identify.pr_head_ref || '';
            const branch_type = process.env.BRANCH_TYPE || '';
            const project_version = process.env.PROJECT_VERSION || '';
            const body = `Official release created from merged PR #${pr_number} by ${pr_user}.\nBranch-based single release for branch ${pr_head_ref} (this release will overwrite previous release for the branch).`;

            let release;
            try {
              release = await github.rest.repos.getReleaseByTag({ owner, repo, tag });
              core.info(`Found existing release id=${release.data.id} for tag=${tag}`);
              await github.rest.repos.updateRelease({ owner, repo, release_id: release.data.id, tag_name: tag, name: `Release ${tag}`, body,
