name: Release on merged PR to main

on:
  workflow_run:
    workflows:
      - "Java CI"
    types:
      - completed

permissions:
  contents: write
  packages: write

jobs:
  release:
    # only run when the triggering Java CI workflow run concluded successfully
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Maven local repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-

      - id: identify_pr_and_artifact
        name: Ensure this run corresponds to a merged PR into main and return artifact
        uses: actions/github-script@v5
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const run = context.payload.workflow_run;
            const runId = run.id;
            const headSha = run.head_sha;
            core.info(`Triggered by Java CI run id=${runId} head_sha=${headSha}`);

            // Find PRs associated with this commit
            const prsResp = await github.rest.repos.listPullRequestsAssociatedWithCommit({ owner, repo, commit_sha: headSha });
            const prs = prsResp.data || [];
            core.info(`Found ${prs.length} PR(s) associated with commit ${headSha}`);

            // Look for a PR that targets main and is merged
            let mergedPr = null;
            for (const p of prs) {
              const prDetails = await github.rest.pulls.get({ owner, repo, pull_number: p.number });
              if (prDetails.data.base && prDetails.data.base.ref === 'main' && prDetails.data.merged === true) {
                mergedPr = prDetails.data;
                break;
              }
            }

            if (!mergedPr) {
              core.info('No merged PR into main associated with this run; skipping release.');
              return { skip: 'true' };
            }

            core.info(`Found merged PR #${mergedPr.number} into main (merged_at=${mergedPr.merged_at})`);

            // Get artifacts for the triggering run
            const arts = await github.rest.actions.listWorkflowRunArtifacts({ owner, repo, run_id: runId });
            if (!arts || !arts.data || !arts.data.artifacts || arts.data.artifacts.length === 0) {
              throw new Error(`No artifacts found for Java CI run ${runId}`);
            }
            const artifact = arts.data.artifacts.find(a => a.name === 'build-artifacts') || arts.data.artifacts[0];
            core.info(`Selected artifact ${artifact.name} (id=${artifact.id}) from run ${runId}`);
            return { archive_url: artifact.archive_download_url, run_id: runId, pr_number: mergedPr.number, pr_user_login: mergedPr.user.login };

      - name: Download and extract Java CI artifact
        run: |
          set -euo pipefail
          ARCHIVE_JSON="${{ steps.identify_pr_and_artifact.outputs.result }}"
          skip=$(echo "$ARCHIVE_JSON" | jq -r '.skip // empty') || true
          if [ "$skip" = "true" ]; then
            echo "No merged PR into main associated with this run; skipping release.";
            exit 0
          fi
          echo "$ARCHIVE_JSON" > /tmp/art.json
          archive_url=$(jq -r '.archive_url' /tmp/art.json)
          if [ -z "$archive_url" ] || [ "$archive_url" = "null" ]; then
            echo "No archive_url found in previous step output" >&2
            cat /tmp/art.json >&2 || true
            exit 1
          fi
          mkdir -p downloaded-artifacts
          echo "Downloading artifact from: $archive_url"
          curl -L -H "Authorization: Bearer $GITHUB_TOKEN" -o /tmp/artifact.zip "$archive_url"
          unzip -o /tmp/artifact.zip -d downloaded-artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - id: determine_tag
        name: Determine tag name from POM or fallback
        run: |
          set -euo pipefail
          version="$(mvn -q -Dexec.executable=echo -Dexec.args='${project.version}' --non-recursive org.codehaus.mojo:exec-maven-plugin:3.1.0:exec || true)"
          echo "POM version: ${version}"
          if [ -n "$version" ] && [[ "$version" != *SNAPSHOT* ]]; then
            tag="v${version}"
          elif [ -n "$version" ]; then
            release_version="${version%-SNAPSHOT}"
            tag="v${release_version}-${GITHUB_RUN_NUMBER}"
          else
            tag="v$(date +%Y%m%d%H%M%S)-${GITHUB_SHA::7}"
          fi
          echo "tag=${tag}" >> "$GITHUB_OUTPUT"

      - name: Create and push tag
        run: |
          set -euo pipefail
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git tag -a "${{ steps.determine_tag.outputs.tag }}" -m "Release ${{ steps.determine_tag.outputs.tag }}"
          git push origin "${{ steps.determine_tag.outputs.tag }}"

      - name: Configure Maven settings for GitHub Packages
        run: |
          mkdir -p $HOME/.m2
          cat > $HOME/.m2/settings.xml <<'SETTINGS'
          <settings>
            <servers>
              <server>
                <id>github</id>
                <username>${env.GITHUB_ACTOR}</username>
                <password>${env.GITHUB_TOKEN}</password>
              </server>
            </servers>
          </settings>
          SETTINGS
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish JAR(s) to GitHub Packages (Maven) using deploy-file
        run: |
          set -euo pipefail
          repo_url="https://maven.pkg.github.com/m-mattei/github-actions-client"
          for jar in downloaded-artifacts/target/*.jar; do
            echo "Publishing $jar to $repo_url"
            mvn -B org.apache.maven.plugins:maven-deploy-plugin:3.0.0:deploy-file \
              -Dfile="$jar" \
              -DpomFile=pom.xml \
              -DrepositoryId=github \
              -Durl="$repo_url"
          done

      - name: Create official release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.determine_tag.outputs.tag }}
          name: Release ${{ steps.determine_tag.outputs.tag }}
          body: |
            Official release created from merged PR #${{ fromJSON(steps.identify_pr_and_artifact.outputs.result).pr_number }} by ${{ fromJSON(steps.identify_pr_and_artifact.outputs.result).pr_user_login }}.
            Artifacts were pulled from the successful Java CI run for the merge commit.
          prerelease: false
          files: downloaded-artifacts/target/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
